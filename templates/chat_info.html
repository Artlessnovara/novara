{% extends "base.html" %}

{% block title %}
    {% if other_user %}
        Contact Info
    {% else %}
        Group Info
    {% endif %}
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<style>
    .info-page-layout {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
    }
    .info-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        border-bottom: 1px solid #eee;
    }
    .info-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin-bottom: 1rem;
    }
    .info-name {
        font-size: 2rem;
        font-weight: 600;
    }
    .info-subtext {
        color: #666;
        margin-top: 0.5rem;
    }
    .role-badge {
        font-size: 0.9rem;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        background-color: #eee;
        color: #333;
        margin-top: 0.5rem;
    }
    .quick-action-row {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }
    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        color: #007bff;
        text-decoration: none;
        font-size: 0.9rem;
    }
    .action-btn i {
        font-size: 1.5rem;
    }
    .media-tabs {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .media-grid img, .media-grid video {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
    }
    .controls-section {
        padding: 1rem;
    }
    .control-item {
        display: block;
        padding: 1rem;
        color: #d9534f;
        text-decoration: none;
        border-bottom: 1px solid #eee;
    }
    .control-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="info-page-layout">
    <!-- Contact Share Modal -->
    <div id="contact-share-modal" class="camera-modal hidden">
        <div class="contact-share-content">
            <h3>Share a contact</h3>
            <div id="contact-list" class="contact-list">
                <!-- Contacts will be populated here by JS -->
            </div>
            <button id="close-contact-modal-btn" class="btn btn-secondary mt-3">Cancel</button>
        </div>
    </div>

    {% if other_user %}
        {# --- ONE-TO-ONE CHAT INFO --- #}
        <div class="glassy-card-container">
            <div class="info-header">
                <img src="{{ url_for('static', filename='profile_pics/' + other_user.profile_pic) }}" alt="{{ other_user.name }}" class="info-avatar">
                <h1 class="info-name">{{ other_user.name }}</h1>
                <p class="info-subtext">{{ other_user.bio or 'No bio available.' }}</p>
                <p id="user-status-info" class="info-subtext user-status"></p>
                <span class="role-badge">{{ other_user.role | capitalize }}</span>
            </div>

            <div class="quick-action-row">
                <a href="{{ url_for('main.chat_room', room_id=room.id) }}" class="action-btn">
                    <i class="fas fa-comment"></i> Message
                </a>
                <a href="#" class="action-btn">
                    <i class="fas fa-phone"></i> Voice Call
                </a>
                <a href="#" class="action-btn">
                    <i class="fas fa-video"></i> Video Call
                </a>
                <a href="#" class="action-btn" id="share-contact-btn">
                    <i class="fas fa-user-plus"></i> Share
                </a>
            </div>

            <div class="media-tabs">
                <h5>Shared Media</h5>
                <div class="media-grid">
                    {% for message in media_messages %}
                        {% if message.file_name.lower().endswith(('png', 'jpg', 'jpeg', 'gif', 'webp')) %}
                            <img src="{{ url_for('static', filename=message.file_path) }}" alt="Shared media">
                        {% elif message.file_name.lower().endswith(('mp4', 'webm', 'ogg')) %}
                            <video src="{{ url_for('static', filename=message.file_path) }}" controls></video>
                        {% endif %}
                    {% else %}
                        <p>No media shared yet.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="controls-section">
                <a href="#" id="mute-btn" class="control-item">
                    {% if is_muted %}Unmute Notifications{% else %}Mute Notifications{% endif %}
                </a>
                <a href="#" id="block-btn" class="control-item">
                    {% if is_blocked %}Unblock Contact{% else %}Block Contact{% endif %}
                </a>
                <a href="#" id="clear-chat-btn" class="control-item text-danger">Clear Chat</a>
                <a href="#" class="control-item">Report Contact</a>
            </div>
        </div>
    {% else %}
        {# --- GROUP CHAT INFO --- #}
        <div class="glassy-card-container">
            <div class="info-header">
                <img src="{{ url_for('static', filename=room.cover_image or 'profile_pics/default.jpg') }}" alt="{{ room.name }}" class="info-avatar">
                <h1 class="info-name">{{ room.name }}</h1>
                <p class="info-subtext">{{ room.description }}</p>
                <p class="info-subtext"><small>Created by {{ room.creator.name }} on {{ room.created_at.strftime('%b %d, %Y') }}</small></p>
            </div>

            <div class="quick-action-row">
                <a href="{{ url_for('main.chat_room', room_id=room.id, action='start_group_call', call_type='voice') }}" class="action-btn">
                    <i class="fas fa-phone"></i> Voice Call
                </a>
                <a href="{{ url_for('main.chat_room', room_id=room.id, action='start_group_call', call_type='video') }}" class="action-btn">
                    <i class="fas fa-video"></i> Video Call
                </a>
            </div>

            <div class="participants-section p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>{{ room.members.count() }} Participants</h5>
                    {% if user_role_in_room == 'admin' %}
                    <div class="btn-group">
                        <a href="{{ url_for('main.add_members', room_id=room.id) }}" class="btn btn-sm btn-outline-primary">Add Participants</a>
                        <button id="invite-link-btn" class="btn btn-sm btn-outline-secondary">Invite via Link</button>
                    </div>
                    {% endif %}
                </div>
                <div id="invite-link-container" class="mt-3 p-2 border rounded" style="display: none;">
                    <p>Share this link to invite people to the group:</p>
                    <div class="input-group">
                        <input type="text" id="invite-link-text" class="form-control" readonly>
                        <button id="copy-link-btn" class="btn btn-outline-secondary" type="button">Copy</button>
                    </div>
                    <button id="revoke-link-btn" class="btn btn-sm btn-danger mt-2">Revoke Link</button>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Search Participants...">
                </div>
                <ul class="list-group list-group-flush">
                    {% for member in room.members %}
                    <a href="{{ url_for('main.user_chat_info', other_user_id=member.user.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <img src="{{ url_for('static', filename='profile_pics/' + member.user.profile_pic) }}" class="rounded-circle me-2" width="30" height="30">
                            {{ member.user.name }}
                        </div>
                        {% if member.role_in_room == 'admin' %}
                            <span class="badge bg-primary rounded-pill">Admin</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </ul>
            </div>

            <div class="controls-section">
                <a href="#" class="control-item">Mute Notifications</a>
                <a href="#" id="clear-chat-btn" class="control-item text-danger">Clear Chat</a>
                <a href="#" class="control-item">Exit Group</a>
                <a href="#" class="control-item">Report Group</a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This script needs access to the socket.io instance and the room ID.
    // Assuming 'socket' is a global variable and room_id is available.
    // This is a limitation of the current structure.

    const contactShareBtn = document.getElementById('share-contact-btn');
    const contactShareModal = document.getElementById('contact-share-modal');
    const closeContactModalBtn = document.getElementById('close-contact-modal-btn');
    const contactList = document.getElementById('contact-list');

    async function openContactShareModal() {
        if (!contactShareModal) return;
        contactList.innerHTML = '<li>Loading...</li>';
        contactShareModal.classList.remove('hidden');

        try {
            const response = await fetch(`/chat/room/${ {{ room.id|tojson }} }/users`);
            const users = await response.json();

            contactList.innerHTML = '';
            users.forEach(user => {
                if (user.id === {{ current_user.id }}) return;

                const item = document.createElement('div');
                item.className = 'contact-item';
                item.dataset.userId = user.id;
                item.innerHTML = `
                    <img src="/static/profile_pics/${user.profile_pic || 'default.jpg'}" alt="${user.name}">
                    <span>${user.name}</span>
                `;
                item.addEventListener('click', () => {
                    if (typeof socket !== 'undefined') {
                        socket.emit('send_contact', {
                            room_id: {{ room.id|tojson }},
                            shared_user_id: user.id
                        });
                        contactShareModal.classList.add('hidden');
                        // Optionally, redirect back to the chat room
                        window.location.href = "{{ url_for('main.chat_room', room_id=room.id) }}";
                    } else {
                        alert("Could not send contact. Connection error.");
                    }
                });
                contactList.appendChild(item);
            });
        } catch (error) {
            console.error('Failed to fetch users:', error);
            contactList.innerHTML = '<li>Failed to load contacts.</li>';
        }
    }

    if (contactShareBtn) {
        contactShareBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openContactShareModal();
        });
    }
    if (closeContactModalBtn) {
        closeContactModalBtn.addEventListener('click', () => {
            contactShareModal.classList.add('hidden');
        });
    }

    // Participant Search Logic
    const searchInput = document.querySelector('input[placeholder="Search Participants..."]');
    if (searchInput) {
        const participantList = searchInput.closest('.participants-section').querySelectorAll('.list-group-item');

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            participantList.forEach(item => {
                const name = item.textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Mute Button Logic
    const muteBtn = document.getElementById('mute-btn');
    if (muteBtn) {
        muteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (typeof socket !== 'undefined') {
                socket.emit('toggle_mute', { room_id: {{ room.id|tojson }} });
            } else {
                alert("Connection error, cannot update mute status.");
            }
        });
    }

    if (typeof socket !== 'undefined') {
        socket.on('mute_status_changed', (data) => {
            if (data.room_id === {{ room.id|tojson }}) {
                if (muteBtn) {
                    muteBtn.textContent = data.is_muted ? 'Unmute Notifications' : 'Mute Notifications';
                }
            }
        });

        socket.on('user_block_status', (data) => {
            if (data.blocked_user_id === {{ other_user.id|tojson }}) {
                const blockBtn = document.getElementById('block-btn');
                if (blockBtn) {
                    blockBtn.textContent = data.is_blocked ? 'Unblock Contact' : 'Block Contact';
                }
                alert(`User has been ${data.is_blocked ? 'blocked' : 'unblocked'}.`);
            }
        });
    }

    const blockBtn = document.getElementById('block-btn');
    if (blockBtn) {
        blockBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (typeof socket !== 'undefined' && {{ other_user.id|tojson }}) {
                socket.emit('toggle_block_user', { blocked_user_id: {{ other_user.id|tojson }} });
            }
        });
    }

    // --- Invite via Link Logic ---
    const inviteBtn = document.getElementById('invite-link-btn');
    const inviteContainer = document.getElementById('invite-link-container');
    const inviteText = document.getElementById('invite-link-text');
    const copyBtn = document.getElementById('copy-link-btn');
    const revokeBtn = document.getElementById('revoke-link-btn');

    if (inviteBtn) {
        inviteBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/admin/chat/room/${ {{ room.id|tojson }} }/generate_invite`, { method: 'POST' });
                const data = await response.json();
                if (data.token) {
                    const joinUrl = new URL(window.location.origin + "{{ url_for('main.join_chat', token='TOKEN') }}".replace('TOKEN', data.token));
                    inviteText.value = joinUrl.href;
                    inviteContainer.style.display = 'block';
                }
            } catch (err) {
                console.error("Failed to generate invite link", err);
                alert("Could not generate invite link.");
            }
        });
    }

    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            inviteText.select();
            navigator.clipboard.writeText(inviteText.value).then(() => {
                alert('Invite link copied to clipboard!');
            });
        });
    }

    if (revokeBtn) {
        revokeBtn.addEventListener('click', async () => {
            try {
                await fetch(`/admin/chat/room/${ {{ room.id|tojson }} }/revoke_invite`, { method: 'POST' });
                inviteText.value = '';
                inviteContainer.style.display = 'none';
                alert('Invite link has been revoked.');
            } catch (err) {
                console.error("Failed to revoke invite link", err);
                alert("Could not revoke invite link.");
            }
        });
    }

    // --- Clear Chat Logic ---
    const clearChatBtn = document.getElementById('clear-chat-btn');
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const confirmed = confirm('Are you sure you want to clear all messages in this chat? This action cannot be undone.');
            if (confirmed) {
                if (typeof socket !== 'undefined') {
                    socket.emit('clear_chat', { room_id: {{ room.id|tojson }} });
                } else {
                    alert("Connection error, cannot clear chat.");
                }
            }
        });
    }

    if (typeof socket !== 'undefined') {
        socket.on('chat_cleared', (data) => {
            if (data.room_id === {{ room.id|tojson }}) {
                alert('Chat has been cleared.');
                // Redirect to the now-empty chat room
                window.location.href = "{{ url_for('main.chat_room', room_id=room.id) }}";
            }
        });
    }

    // --- User Status Logic ---
    const userStatusInfo = document.getElementById('user-status-info');
    const otherUserId = {{ other_user.id|tojson }};

    function formatLastSeen(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const now = new Date();
        const diffSeconds = Math.round((now - date) / 1000);

        if (diffSeconds < 60) return 'last seen just now';
        if (diffSeconds < 3600) return `last seen ${Math.floor(diffSeconds / 60)} minutes ago`;
        if (diffSeconds < 86400) return `last seen ${Math.floor(diffSeconds / 3600)} hours ago`;

        return `last seen on ${date.toLocaleDateString()}`;
    }

    if (otherUserId && userStatusInfo) {
        // You would typically fetch the initial status via an API call,
        // but for now we'll just wait for socket events.
        userStatusInfo.textContent = 'loading...'; // Initial state

        socket.on('user_online', (data) => {
            if (data.user_id === otherUserId) {
                userStatusInfo.textContent = 'Online';
            }
        });

        socket.on('user_offline', (data) => {
            if (data.user_id === otherUserId) {
                userStatusInfo.textContent = formatLastSeen(data.last_seen);
            }
        });

        // Request initial status
        if(typeof socket !== 'undefined') {
            socket.emit('get_user_status', { 'user_id': otherUserId });
        }

        socket.on('user_status_response', (data) => {
            if(data.user_id === otherUserId) {
                if (data.is_online) {
                    userStatusInfo.textContent = 'Online';
                } else {
                    userStatusInfo.textContent = formatLastSeen(data.last_seen);
                }
            }
        });
    }
});
</script>
{% endblock %}
