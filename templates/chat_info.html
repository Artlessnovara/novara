{% extends "base.html" %}

{% block title %}
    {% if other_user %}
        Contact Info
    {% else %}
        Group Info
    {% endif %}
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<style>
    .info-page-layout {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
    }
    .info-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        border-bottom: 1px solid #eee;
    }
    .info-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin-bottom: 1rem;
    }
    .info-name {
        font-size: 2rem;
        font-weight: 600;
    }
    .info-subtext {
        color: #666;
        margin-top: 0.5rem;
    }
    .role-badge {
        font-size: 0.9rem;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        background-color: #eee;
        color: #333;
        margin-top: 0.5rem;
    }
    .quick-action-row {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }
    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        color: #007bff;
        text-decoration: none;
        font-size: 0.9rem;
    }
    .action-btn i {
        font-size: 1.5rem;
    }
    .media-tabs {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .media-grid img, .media-grid video {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
    }
    .controls-section {
        padding: 1rem;
    }
    .control-item {
        display: block;
        padding: 1rem;
        color: #d9534f;
        text-decoration: none;
        border-bottom: 1px solid #eee;
    }
    .control-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="info-page-layout">
    <!-- Contact Share Modal -->
    <div id="contact-share-modal" class="camera-modal hidden">
        <div class="contact-share-content">
            <h3>Share a contact</h3>
            <div id="contact-list" class="contact-list">
                <!-- Contacts will be populated here by JS -->
            </div>
            <button id="close-contact-modal-btn" class="btn btn-secondary mt-3">Cancel</button>
        </div>
    </div>

    {% if other_user %}
        {# --- ONE-TO-ONE CHAT INFO --- #}
        <div class="glassy-card-container">
            <div class="info-header">
                <img src="{{ url_for('static', filename='profile_pics/' + other_user.profile_pic) }}" alt="{{ other_user.name }}" class="info-avatar">
                <h1 class="info-name">{{ other_user.name }}</h1>
                <p class="info-subtext">{{ other_user.bio or 'No bio available.' }}</p>
                <span class="role-badge">{{ other_user.role | capitalize }}</span>
            </div>

            <div class="quick-action-row">
                <a href="{{ url_for('main.chat_room', room_id=room.id) }}" class="action-btn">
                    <i class="fas fa-comment"></i> Message
                </a>
                <a href="#" class="action-btn">
                    <i class="fas fa-phone"></i> Voice Call
                </a>
                <a href="#" class="action-btn">
                    <i class="fas fa-video"></i> Video Call
                </a>
                <a href="#" class="action-btn" id="share-contact-btn">
                    <i class="fas fa-user-plus"></i> Share
                </a>
            </div>

            <div class="media-tabs">
                <h5>Shared Media</h5>
                <div class="media-grid">
                    {% for message in media_messages %}
                        {% if message.file_name.lower().endswith(('png', 'jpg', 'jpeg', 'gif', 'webp')) %}
                            <img src="{{ url_for('static', filename=message.file_path) }}" alt="Shared media">
                        {% elif message.file_name.lower().endswith(('mp4', 'webm', 'ogg')) %}
                            <video src="{{ url_for('static', filename=message.file_path) }}" controls></video>
                        {% endif %}
                    {% else %}
                        <p>No media shared yet.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="controls-section">
                <a href="#" class="control-item">Mute Notifications</a>
                <a href="#" class="control-item">Block Contact</a>
                <a href="#" class="control-item">Report Contact</a>
                <a href="#" class="control-item">Clear Chat</a>
            </div>
        </div>
    {% else %}
        {# --- GROUP CHAT INFO --- #}
        <div class="glassy-card-container">
            <div class="info-header">
                <img src="{{ url_for('static', filename=room.cover_image or 'profile_pics/default.jpg') }}" alt="{{ room.name }}" class="info-avatar">
                <h1 class="info-name">{{ room.name }}</h1>
                <p class="info-subtext">{{ room.description }}</p>
                <p class="info-subtext"><small>Created by {{ room.creator.name }} on {{ room.created_at.strftime('%b %d, %Y') }}</small></p>
            </div>

            <div class="participants-section p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>{{ room.members.count() }} Participants</h5>
                    {% if user_role_in_room == 'admin' %}
                    <a href="{{ url_for('main.add_members', room_id=room.id) }}" class="btn btn-sm btn-outline-primary">Add Participants</a>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Search Participants...">
                </div>
                <ul class="list-group list-group-flush">
                    {% for member in room.members %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <img src="{{ url_for('static', filename='profile_pics/' + member.user.profile_pic) }}" class="rounded-circle me-2" width="30" height="30">
                            {{ member.user.name }}
                        </div>
                        {% if member.role_in_room == 'admin' %}
                            <span class="badge bg-primary rounded-pill">Admin</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="controls-section">
                <a href="#" class="control-item">Mute Notifications</a>
                <a href="#" class="control-item">Exit Group</a>
                <a href="#" class="control-item">Report Group</a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This script needs access to the socket.io instance and the room ID.
    // Assuming 'socket' is a global variable and room_id is available.
    // This is a limitation of the current structure.

    const contactShareBtn = document.getElementById('share-contact-btn');
    const contactShareModal = document.getElementById('contact-share-modal');
    const closeContactModalBtn = document.getElementById('close-contact-modal-btn');
    const contactList = document.getElementById('contact-list');

    async function openContactShareModal() {
        if (!contactShareModal) return;
        contactList.innerHTML = '<li>Loading...</li>';
        contactShareModal.classList.remove('hidden');

        try {
            const response = await fetch(`/chat/room/${ {{ room.id|tojson }} }/users`);
            const users = await response.json();

            contactList.innerHTML = '';
            users.forEach(user => {
                if (user.id === {{ current_user.id }}) return;

                const item = document.createElement('div');
                item.className = 'contact-item';
                item.dataset.userId = user.id;
                item.innerHTML = `
                    <img src="/static/profile_pics/${user.profile_pic || 'default.jpg'}" alt="${user.name}">
                    <span>${user.name}</span>
                `;
                // This part won't work as 'socket' is not defined on this page.
                // This highlights a need for a shared JS file/architecture.
                // For now, this button will not be functional.
                item.addEventListener('click', () => {
                    alert("Contact sharing must be done from the main chat window for now.");
                    contactShareModal.classList.add('hidden');
                });
                contactList.appendChild(item);
            });
        } catch (error) {
            console.error('Failed to fetch users:', error);
            contactList.innerHTML = '<li>Failed to load contacts.</li>';
        }
    }

    if (contactShareBtn) {
        contactShareBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openContactShareModal();
        });
    }
    if (closeContactModalBtn) {
        closeContactModalBtn.addEventListener('click', () => {
            contactShareModal.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
