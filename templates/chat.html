{% extends "layouts/chat_layout.html" %}

{% block title %}{{ current_room.name }} - GloobaApp{% endblock %}

{% block content %}
<!-- Chat-specific Top Bar -->
<header class="top-bar chat-view-header">
    <a href="{{ url_for('main.chat_list') }}" class="back-button"><i class="fas fa-arrow-left"></i></a>
    <div class="chat-info">
        <img src="{{ url_for('static', filename=current_room.cover_image or 'images/default_avatar.png') }}" alt="Avatar" class="chat-avatar">
        <span class="chat-name">{{ current_room.name }}</span>
    </div>
    <div class="actions">
        <a href="#" class="icon-btn"><i class="fas fa-video"></i></a>
        <a href="#" class="icon-btn"><i class="fas fa-phone-alt"></i></a>
        <a href="{{ url_for('main.chat_room_info', room_id=current_room.id) }}" class="icon-btn"><i class="fas fa-ellipsis-v"></i></a>
    </div>
</header>

<!-- Messages Area -->
<main id="messages" class="chat-area">
    {% for message in messages %}
        <div class="message-container {% if message.user_id == current_user.id %}sender{% else %}receiver{% endif %}">
            <div class="message-bubble">
                <div class="author">{{ message.author.name }}</div>
                <div class="content">{{ message.content }}</div>
                <div class="timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</div>
            </div>
        </div>
    {% endfor %}
</main>

<!-- Message Input Bar -->
<div class="chat-input-bar">
    <div id="reply-banner" style="display: none; width: 100%; background-color: var(--search-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px;">
        <div id="reply-banner-text" style="font-size: 13px;"></div>
        <button id="cancel-reply-btn" style="background: none; border: none; color: var(--icon-color); float: right; cursor: pointer;">&times;</button>
    </div>
    <div class="input-actions-wrapper">
        <button id="emoji-btn" class="icon-btn"><i class="far fa-smile"></i></button>
        <textarea id="message-input" class="message-input" placeholder="Type a message..." rows="1"></textarea>
        <button id="attach-btn" class="icon-btn"><i class="fas fa-paperclip"></i></button>
        <button id="mic-btn" class="icon-btn"><i class="fas fa-microphone"></i></button>
        <button id="send-btn" class="send-btn" style="display:none;"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div id="attachment-options" style="display: none; padding: 10px 0;">
        <button id="media-btn" class="attachment-option-btn">Image/Video</button>
        <button id="doc-btn" class="attachment-option-btn">Document</button>
        <button id="poll-btn" class="attachment-option-btn">Poll</button>
    </div>
</div>
<input type="file" id="file-input" style="display: none;" multiple>
<emoji-picker style="display: none; position: absolute; bottom: 60px; right: 20px; z-index: 1002;"></emoji-picker>

<!-- Poll Modal -->
<div id="poll-modal-backdrop" class="poll-modal-backdrop">
    <div class="poll-modal-content">
        <h3>Create a Poll</h3>
        <input type="text" id="poll-question" placeholder="Enter your poll question">
        <div id="poll-options-container" class="poll-options-container">
            <div class="poll-option">
                <input type="text" class="poll-option-input" placeholder="Option 1">
            </div>
            <div class="poll-option">
                <input type="text" class="poll-option-input" placeholder="Option 2">
            </div>
        </div>
        <button id="add-poll-option-btn" class="add-option-btn">+ Add Option</button>
        <div class="poll-modal-buttons">
            <button id="cancel-poll-btn">Cancel</button>
            <button id="create-poll-submit-btn">Create Poll</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const currentRoomId = {{ current_room.id }};
    const currentUserId = {{ current_user.id }};

    // --- DOM Elements ---
    const messageWindow = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const micBtn = document.getElementById('mic-btn');
    const attachBtn = document.getElementById('attach-btn');
    const attachmentOptions = document.getElementById('attachment-options');
    const mediaBtn = document.getElementById('media-btn');
    const docBtn = document.getElementById('doc-btn');
    const pollBtn = document.getElementById('poll-btn');
    const fileInput = document.getElementById('file-input');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.querySelector('emoji-picker');
    const replyBanner = document.getElementById('reply-banner');
    const replyBannerText = document.getElementById('reply-banner-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');

    // Poll Modal Elements
    const pollModalBackdrop = document.getElementById('poll-modal-backdrop');
    const pollQuestionInput = document.getElementById('poll-question');
    const pollOptionsContainer = document.getElementById('poll-options-container');
    const addPollOptionBtn = document.getElementById('add-poll-option-btn');
    const createPollSubmitBtn = document.getElementById('create-poll-submit-btn');
    const cancelPollBtn = document.getElementById('cancel-poll-btn');

    let repliedToMessage = null;

    // --- SocketIO Event Handlers ---
    socket.on('connect', () => {
        socket.emit('join', { room_id: currentRoomId });
    });

    socket.on('message', (data) => {
        if (data.room_id == currentRoomId) {
            addMessage(data);
        }
    });

    socket.on('new_poll', (data) => {
        if (data.room_id == currentRoomId) {
            addPoll(data);
        }
    });

    socket.on('poll_update', (data) => {
        if (data.room_id == currentRoomId) {
            updatePoll(data);
        }
    });

    // --- UI Event Listeners ---
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value.trim() !== '') {
            micBtn.style.display = 'none';
            sendBtn.style.display = 'flex';
        } else {
            micBtn.style.display = 'flex';
            sendBtn.style.display = 'none';
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
            this.style.height = 'auto';
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    attachBtn.addEventListener('click', () => {
        attachmentOptions.style.display = attachmentOptions.style.display === 'none' ? 'block' : 'none';
    });

    mediaBtn.addEventListener('click', () => {
        fileInput.accept = "image/*,video/*";
        fileInput.click();
    });

    docBtn.addEventListener('click', () => {
        fileInput.accept = ".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt";
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            for(const file of this.files) {
                uploadFile(file);
            }
        }
    });

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.style.display = 'none';
        }
    });

    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
        messageInput.dispatchEvent(new Event('input')); // Trigger input event to show send button
    });

    cancelReplyBtn.addEventListener('click', () => {
        repliedToMessage = null;
        replyBanner.style.display = 'none';
    });

    // --- Poll UI Handlers ---
    pollBtn.addEventListener('click', () => {
        pollModalBackdrop.style.display = 'flex';
        attachmentOptions.style.display = 'none';
    });

    cancelPollBtn.addEventListener('click', () => {
        pollModalBackdrop.style.display = 'none';
    });

    addPollOptionBtn.addEventListener('click', () => {
        const optionCount = pollOptionsContainer.children.length;
        const newOption = document.createElement('div');
        newOption.classList.add('poll-option');
        newOption.innerHTML = `<input type="text" class="poll-option-input" placeholder="Option ${optionCount + 1}">`;
        pollOptionsContainer.appendChild(newOption);
    });

    createPollSubmitBtn.addEventListener('click', () => {
        const question = pollQuestionInput.value.trim();
        const options = [...pollOptionsContainer.querySelectorAll('.poll-option-input')]
            .map(input => input.value.trim())
            .filter(option => option !== '');

        if (!question || options.length < 2) {
            alert('Please enter a question and at least two options.');
            return;
        }

        socket.emit('create_poll', {
            room_id: currentRoomId,
            question: question,
            options: options
        });

        pollModalBackdrop.style.display = 'none';
    });

    // --- Helper Functions ---
    function sendMessage() {
        const content = messageInput.value.trim();
        if (content) {
            let messageData = { room_id: currentRoomId, content: content };
            if (repliedToMessage) {
                messageData.replied_to_id = repliedToMessage.id;
            }
            socket.emit('message', messageData);
            messageInput.value = '';
            messageInput.dispatchEvent(new Event('input'));
            repliedToMessage = null;
            replyBanner.style.display = 'none';
        }
    }

    function addMessage(data) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');
        messageContainer.classList.add(data.user_id === currentUserId ? 'sender' : 'receiver');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        const ts = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let fileHtml = '';
        if (data.file_path) {
            const filePath = `/static/${data.file_path}`;
            if (data.file_name.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                 fileHtml = `<img src="${filePath}" alt="Image" style="max-width: 100%; border-radius: 10px; margin-top: 5px;">`;
            } else {
                 fileHtml = `<a href="${filePath}" target="_blank" class="chat-file-link">${data.file_name}</a>`;
            }
        }

        bubble.innerHTML = `
            <div class="author">${data.user_name}</div>
            <div class="content">${data.content || ''}</div>
            ${fileHtml}
            <div class="timestamp">${ts}</div>
        `;

        messageContainer.appendChild(bubble);
        messageWindow.appendChild(messageContainer);
        messageWindow.scrollTop = messageWindow.scrollHeight;
    }

    function addPoll(data) {
        const messageContainer = document.createElement('div');
        messageContainer.id = `message-${data.message_id}`;
        messageContainer.classList.add('message-container', 'receiver');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        const ts = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let optionsHtml = '';
        for (const option of data.options) {
            optionsHtml += `
                <div class="poll-option-bar" data-option-id="${option.id}">
                    <div class="poll-option-fill" style="width: 0%;"></div>
                    <span class="poll-option-text">${option.text}</span>
                    <span class="poll-option-votes">0 votes</span>
                </div>
            `;
        }

        bubble.innerHTML = `
            <div class="author">${data.user_name}</div>
            <div class="poll-container" id="poll-${data.poll_id}">
                <div class="poll-question">${data.question}</div>
                <div class="poll-options">${optionsHtml}</div>
            </div>
            <div class="timestamp">${ts}</div>
        `;

        messageContainer.appendChild(bubble);
        messageWindow.appendChild(messageContainer);
        messageWindow.scrollTop = messageWindow.scrollHeight;

        bubble.querySelectorAll('.poll-option-bar').forEach(bar => {
            bar.addEventListener('click', () => {
                const optionId = bar.dataset.optionId;
                socket.emit('poll_vote', { option_id: optionId });
            });
        });
    }

    function updatePoll(data) {
        const pollContainer = document.getElementById(`poll-${data.poll_id}`);
        if (!pollContainer) return;

        const totalVotes = data.options.reduce((sum, opt) => sum + opt.votes, 0);

        for (const option of data.options) {
            const optionBar = pollContainer.querySelector(`[data-option-id="${option.id}"]`);
            if (optionBar) {
                const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                optionBar.querySelector('.poll-option-fill').style.width = `${percentage}%`;
                optionBar.querySelector('.poll-option-votes').textContent = `${option.votes} votes`;
            }
        }
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        fetch('/chat/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Upload failed: ' + data.error);
            } else {
                socket.emit('message', {
                    room_id: currentRoomId,
                    content: '',
                    file_path: data.file_path,
                    file_name: data.file_name
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}