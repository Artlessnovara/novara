{% extends "layouts/dashboard_layout.html" %}

{% block dashboard_content %}
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <h1 class="typewriter">Welcome back, {{ current_user.name }}!</h1>
        <p>Let's continue your learning journey.</p>
    </div>

    <!-- Profile Completion & Quick Stats -->
    <div class="dashboard-grid mb-3">
        <div class="card">
            <div class="card-header">Profile Completion</div>
            <p>Complete your profile to get the most out of our platform.</p>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ profile_completion_percentage }}%;"></div>
            </div>
            <span style="font-size: 0.9rem; color: #64748b;">{{ profile_completion_percentage }}% Complete</span>
        </div>
        <div class="card">
            <div class="card-header">Quick Stats</div>
            <p><strong>Active Courses:</strong> {{ active_courses_count }}</p>
            <p><strong>Completed:</strong> {{ completed_courses_count }}</p>
            <p><strong>Certificates:</strong> {{ certificates_count }}</p>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- My Courses -->
        <div class="card col-span-2" id="my-courses">
            <div class="card-header">My Courses</div>
            <div class="course-list">
                {% for data in enrollment_data %}
                    <div class="course-item">
                        <div>
                            <strong>{{ data.enrollment.course.title }}</strong>
                            <div class="progress-bar-container" style="max-width: 200px; margin-top: 5px;">
                                <div class="progress-bar" style="width: {{ data.progress.percentage | default(0) }}%;"></div>
                            </div>
                        </div>
                        <div>
                            <a href="{{ url_for('main.course_detail', course_id=data.enrollment.course.id) }}" class="btn-primary">Continue Learning</a>
                            {% if data.progress.can_request_certificate %}
                                <form action="{{ url_for('main.request_certificate', course_id=data.enrollment.course.id) }}" method="POST" style="display: inline-block; margin-left: 10px;">
                                    <button type="submit" class="btn-secondary">Request Certificate</button>
                                </form>
                            {% else %}
                                <a class="btn-secondary btn-disabled" title="Complete all requirements to unlock. Missing: {{ data.progress.reasons|join(', ') }}" style="margin-left: 10px;">Request Certificate</a>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <p>You are not enrolled in any courses yet. <a href="{{ url_for('main.courses') }}">Browse courses</a>.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Grades & Performance -->
        <div class="card">
            <div class="card-header">Score History</div>
            <canvas id="scoreChart"></canvas>
        </div>
    </div>
{% endblock %}

{% block dashboard_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('scoreChart');
            const chartData = JSON.parse('{{ chart_data|tojson|safe }}');

            if (ctx && chartData && chartData.labels.length > 0) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Recent Scores (%)',
                            data: chartData.scores,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } else if (ctx) {
                const context = ctx.getContext('2d');
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText("No score history available yet.", ctx.width / 2, ctx.height / 2);
            }
        });
    </script>
{% endblock %}
