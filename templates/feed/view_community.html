{% extends "feed/base.html" %}

{% block title %}{{ community.name }}{% endblock %}

{% block styles %}
<style>
    .community-container { max-width: 900px; margin: auto; }
    .community-header {
        background-color: var(--card-bg-light);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        padding: 2rem;
        text-align: center;
    }
    .community-cover {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 1rem;
        display: block;
        border: 4px solid var(--card-bg-light);
        box-shadow: var(--shadow-sm);
    }
    .join-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 1rem;
        font-size: 1.1rem;
    }

    /* Styles copied from home.html for posts */
    .post-container {
        background: var(--card-bg-light);
        padding-top: 1rem;
        border-bottom: 1px solid var(--border-color-light);
    }
    .post-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
    }
    .post-author {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .post-author-info { font-weight: 600; }
    .post-author-info span { display: block; font-size: 0.8rem; color: var(--secondary-text-light); font-weight: 400; }
    .post-content { padding: 0 1rem 1rem; }
    .post-media img, .post-media video { max-width: 100%; border-radius: 0; }
    .post-stats {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        color: var(--secondary-text-light);
        border-top: 1px solid var(--border-color-light);
    }
    .post-actions {
        display: flex;
        justify-content: space-around;
        border-top: 1px solid var(--border-color-light);
    }
    .post-actions .action-btn {
        flex: 1;
        background: none;
        border: none;
        color: var(--secondary-text-light);
        font-weight: 600;
        cursor: pointer;
        padding: 0.75rem;
        border-radius: 0;
        transition: background-color 0.2s;
    }
    .post-actions .action-btn:hover { background-color: var(--hover-overlay-light); }
    .post-actions .action-btn.active { color: var(--primary-color); }

    .comments-section {
        padding: 0 1rem 1rem;
        border-top: 1px solid var(--border-color-light);
        display: none;
    }
    .comment { display: flex; gap: 10px; margin-top: 1rem; }
    .comment-content { background: var(--background-color-light); padding: 0.5rem 1rem; border-radius: 15px; }
    .comment-form { display: flex; gap: 10px; margin-top: 1rem; }
    .comment-input { flex-grow: 1; border: 1px solid var(--border-color-light); border-radius: 20px; padding: 8px 15px; }
    .post-more-options { position: relative; }
    .more-options-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--card-bg-light);
        border: 1px solid var(--border-color-light);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        z-index: 10;
        list-style: none;
        padding: 0.5rem 0;
        margin: 0;
        min-width: 150px;
    }
    .more-options-menu a {
        display: block;
        padding: 0.5rem 1rem;
        text-decoration: none;
        color: var(--text-color-light);
    }
    .more-options-menu a:hover {
        background-color: var(--hover-overlay-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="community-container">
    <div class="community-header">
        <img src="{{ url_for('static', filename=community.cover_image or 'images/course_placeholder.jpg') }}" alt="{{ community.name }} Cover" class="community-cover">
        <h1>{{ community.name }}</h1>
        <p>{{ community.description }}</p>

        {% if current_user.is_authenticated %}
            {% set membership = community.memberships.filter_by(user_id=current_user.id).first() %}
            {% if not membership %}
                <form action="{{ url_for('feed.join_community', community_id=community.id) }}" method="POST">
                    <button type="submit" class="join-btn">Join Community</button>
                </form>
            {% else %}
                <p><strong>You are a member!</strong></p>
            {% endif %}
        {% endif %}
    </div>

    <div class="community-body">
        {% if membership %}
        <div class="create-post-card" style="margin-bottom: 2rem;">
            <h3>Create a Post in {{ community.name }}</h3>
            <form id="create-post-form" action="{{ url_for('feed.create_post') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="community_id" value="{{ community.id }}">
                <div class="form-group">
                    <textarea name="content" placeholder="Share something with the community..." required style="width: 100%; min-height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <input type="file" id="media-input" name="media" accept="image/*,video/*">
                </div>
                <button type="submit" class="btn-primary">Post</button>
            </form>
        </div>
        {% endif %}

        <div class="posts-list">
            {% for post in posts %}
            <div class="post-container" data-post-id="{{ post.id }}">
                <div class="post-header">
                    <div class="post-author">
                        <img src="{{ url_for('static', filename='profile_pics/' + post.author.profile_pic) }}" alt="{{ post.author.name }}" class="profile-pic-small">
                        <div class="post-author-info">
                            <a href="{{ url_for('feed.profile', user_id=post.author.id) }}" style="text-decoration: none; color: inherit;">{{ post.author.name }}</a>
                            <span>{{ post.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</span>
                        </div>
                    </div>
                    <div class="post-more-options">
                        <button class="icon-btn more-options-btn"><i class="fas fa-ellipsis-h"></i></button>
                        <ul class="more-options-menu">
                            <li><a href="{{ url_for('feed.report_post', post_id=post.id) }}">Report Post</a></li>
                        </ul>
                    </div>
                </div>

                <div class="post-content">
                    <p>{{ post.content }}</p>
                </div>

                {% if post.media_url %}
                <div class="post-media">
                    {% if post.media_type == 'image' %}
                        <img src="{{ url_for('static', filename=post.media_url) }}" alt="Post image">
                    {% elif post.media_type == 'video' %}
                        <video src="{{ url_for('static', filename=post.media_url) }}" controls style="width: 100%;"></video>
                    {% endif %}
                </div>
                {% endif %}

                <div class="post-stats">
                    <span class="likes-count">{{ post.likes.count() }} Likes</span>
                    <span class="comments-count">{{ post.comments.count() }} Comments</span>
                </div>

                <div class="post-actions">
                    <button class="action-btn like-btn {% if current_user.id in post.likes|map(attribute='user_id')|list %}active{% endif %}">
                        <i class="fas fa-thumbs-up"></i> Like
                    </button>
                    <button class="action-btn comment-btn">
                        <i class="fas fa-comment"></i> Comment
                    </button>
                </div>

                <div class="comments-section">
                    <div class="comment-form">
                        <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" alt="Your Profile Pic" class="profile-pic-small">
                        <input type="text" class="comment-input" placeholder="Write a comment...">
                        <button class="btn-primary comment-submit-btn" style="border-radius: 20px;">Post</button>
                    </div>
                    <div class="comments-list"></div>
                </div>
            </div>
            {% else %}
                <p style="text-align: center; padding: 2rem;">No posts in this community yet. Be the first to share something!</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// This script is copied from home.html to provide like/comment functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.post-container').forEach(postContainer => {
        const postId = postContainer.dataset.postId;
        const likeBtn = postContainer.querySelector('.like-btn');
        const likesCountSpan = postContainer.querySelector('.likes-count');
        const commentBtn = postContainer.querySelector('.comment-btn');
        const commentsSection = postContainer.querySelector('.comments-section');
        const commentsList = postContainer.querySelector('.comments-list');
        const commentInput = postContainer.querySelector('.comment-input');
        const commentSubmitBtn = postContainer.querySelector('.comment-submit-btn');
        const moreOptionsBtn = postContainer.querySelector('.more-options-btn');
        const moreOptionsMenu = postContainer.querySelector('.more-options-menu');

        if (moreOptionsBtn) {
            moreOptionsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                document.querySelectorAll('.more-options-menu').forEach(menu => {
                    if (menu !== moreOptionsMenu) menu.style.display = 'none';
                });
                moreOptionsMenu.style.display = moreOptionsMenu.style.display === 'block' ? 'none' : 'block';
            });
        }

        if (likeBtn) {
            likeBtn.addEventListener('click', () => {
                fetch(`/feed/api/post/${postId}/like`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        likesCountSpan.textContent = `${data.likes_count} Likes`;
                        likeBtn.classList.toggle('active', data.liked_by_user);
                    }
                });
            });
        }

        if (commentBtn) {
            commentBtn.addEventListener('click', () => {
                const isHidden = commentsSection.style.display === 'none' || commentsSection.style.display === '';
                if (isHidden) {
                    commentsSection.style.display = 'block';
                    if (commentsList.innerHTML.trim() === '') {
                        fetchAndRenderComments(postId, commentsList);
                    }
                } else {
                    commentsSection.style.display = 'none';
                }
            });
        }

        if (commentSubmitBtn) {
            commentSubmitBtn.addEventListener('click', () => {
                const content = commentInput.value.trim();
                if (content) {
                    fetch(`/feed/api/post/${postId}/comment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: content }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            appendComment(data.comment, commentsList);
                            commentInput.value = '';
                        }
                    });
                }
            });
        }
    });

    function fetchAndRenderComments(postId, commentsListEl) {
        commentsListEl.innerHTML = '<p>Loading...</p>';
        fetch(`/feed/api/post/${postId}/comments`)
            .then(response => response.json())
            .then(data => {
                commentsListEl.innerHTML = '';
                if (data.length === 0) {
                    commentsListEl.innerHTML = '<p style="font-size: 0.9rem; color: #888; margin-top: 1rem;">No comments yet.</p>';
                } else {
                    data.forEach(comment => appendComment(comment, commentsListEl));
                }
            });
    }

    function appendComment(comment, commentsListEl) {
        const noCommentsMsg = commentsListEl.querySelector('p');
        if (noCommentsMsg) noCommentsMsg.remove();

        const commentEl = document.createElement('div');
        commentEl.classList.add('comment');
        commentEl.innerHTML = `
            <img src="${comment.author.profile_pic}" alt="${comment.author.name}" class="profile-pic-small">
            <div class="comment-content">
                <a href="/feed/profile/${comment.author.id}" style="font-weight: 600; text-decoration: none; color: inherit;">${comment.author.name}</a>
                <p style="margin: 0.25rem 0 0;">${comment.content}</p>
            </div>
        `;
        commentsListEl.appendChild(commentEl);
    }

    window.addEventListener('click', () => {
        document.querySelectorAll('.more-options-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    });
});
</script>
{% endblock %}
