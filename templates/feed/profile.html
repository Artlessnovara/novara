{% extends "layouts/dashboard_layout.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}{{ user.name }}'s Profile{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile_reborn.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="profile-container">
    <!-- Optional top banner for profile completion -->
    {% if profile_completion < 100 %}
    <div class="completion-banner">
        <p>Your profile is only {{ profile_completion }}% complete. <a href="#">Complete it now</a> to get the most out of our platform!</p>
    </div>
    {% endif %}

    <!-- Phase 2: Hero / Cover Section -->
    <section class="profile-hero">
        <div class="cover-image" style="background-image: url('{{ user.profile_banner_url or url_for('static', filename='images/course_placeholder.jpg') }}');">
            <!-- This div is for the background image -->
        </div>
        <div class="profile-card-container">
            <div class="profile-photo-wrapper">
                <img src="{{ url_for('static', filename='profile_pics/' + user.profile_pic) }}" alt="{{ user.name }}'s profile photo" class="profile-photo">
            </div>
            <div class="profile-info">
                <h1>{{ user.name }}</h1>
                <p class="tagline">{{ user.bio or 'Eager to learn and grow.' }}</p>
            </div>
            <div class="profile-actions">
                {% if user.id == current_user.id %}
                    <button class="btn btn-primary edit-profile-btn">Edit Profile</button>
                {% else %}
                    {% if has_blocked %}
                        <button class="btn btn-danger unblock-user-btn" data-user-id="{{ user.id }}">Unblock</button>
                    {% else %}
                        <button class="btn btn-secondary block-user-btn" data-user-id="{{ user.id }}">Block</button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Phase 3: Stats Strip / Key Metrics -->
    <section class="stats-strip">
        <div class="stats-grid">
            <div class="stat-card card">
                <h3>Profile Completion</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: {{ profile_completion }}%;"></div>
                </div>
                <span class="stat-value">{{ profile_completion }}%</span>
            </div>
            <div class="stat-card card">
                <h3>Certificates</h3>
                <span class="stat-value">{{ certificates|length }}</span>
                <p class="stat-label">Earned</p>
            </div>
            <div class="stat-card card">
                <h3>Badges</h3>
                <span class="stat-value">{{ badges|length }}</span>
                <p class="stat-label">Collected</p>
            </div>
        </div>
    </section>

    <!-- Role-Specific Section: Courses -->
    {% if current_user.role == 'instructor' %}
    <section class="profile-section card">
        <div class="section-header">
            <h2>Courses I'm Teaching</h2>
            <a href="{{ url_for('instructor.create_course') }}" class="btn btn-primary">+ Create New</a>
        </div>
        <div class="courses-grid">
            {% for course in courses %}
                <div class="course-card">
                    <a href="{{ url_for('main.course_detail', course_id=course.id) }}">
                        <img src="{{ course.cover_image or url_for('static', filename='images/course_placeholder.jpg') }}" alt="{{ course.title }} cover">
                        <div class="course-card-content">
                            <h4>{{ course.title }}</h4>
                            <p>{{ (course.description or '') | truncate(80) }}</p>
                        </div>
                    </a>
                </div>
            {% else %}
                <p>No courses to display.</p>
            {% endfor %}
        </div>
    </section>
    {% elif current_user.role == 'student' %}
    <section class="profile-section card">
        <div class="section-header">
            <h2>My Enrolled Courses</h2>
        </div>
        <div class="courses-grid">
            {% for course in courses %}
                <div class="course-card">
                    <a href="{{ url_for('main.course_detail', course_id=course.id) }}">
                        <img src="{{ course.cover_image or url_for('static', filename='images/course_placeholder.jpg') }}" alt="{{ course.title }} cover">
                        <div class="course-card-content">
                            <h4>{{ course.title }}</h4>
                            <p>{{ (course.description or '') | truncate(80) }}</p>
                        </div>
                    </a>
                </div>
            {% else %}
                <p>You are not enrolled in any courses yet. <a href="{{ url_for('main.courses') }}">Explore courses</a>.</p>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Admin-Specific Section -->
    {% if current_user.role == 'admin' %}
    <section class="profile-section admin-actions card">
        <div class="section-header">
            <h2>Admin Actions</h2>
        </div>
        <div class="action-buttons">
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">Manage Users</a>
            <a href="{{ url_for('admin.manage_permissions') }}" class="btn btn-secondary">Manage Permissions</a>
        </div>
    </section>
    {% endif %}

    <!-- Phase 4: Certificates Section -->
    <section class="profile-section card">
        <div class="section-header">
            <h2>My Certificates</h2>
            <button id="add-certificate-btn" class="btn btn-secondary">+ Add</button>
        </div>
        <div class="certificates-list">
            {% for cert in certificates %}
            <div class="certificate-item">
                <div class="cert-icon"><i class="fas fa-award"></i></div>
                <div class="cert-details">
                    <h4>{{ cert.course.title }}</h4>
                    <p>Issued: {{ cert.issued_at.strftime('%B %d, %Y') }}</p>
                </div>
                <a href="#" class="btn-view-cert"><i class="fas fa-eye"></i></a>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No certificates earned yet. <a href="{{ url_for('main.courses') }}">Start a course</a> to earn your first one!</p>
            </div>
            {% endfor %}
        </div>
        {% if certificates %}
        <a href="#" class="view-all-link">View All Certificates</a>
        {% endif %}
    </section>

    <!-- Phase 5: Achievements / Badges Carousel -->
    <section class="profile-section card">
        <div class="section-header">
            <h2>Achievements & Badges</h2>
        </div>
        <div class="badges-carousel">
            {% for badge in badges %}
            <div class="badge-item">
                <img src="{{ badge.icon_url or url_for('static', filename='images/course_placeholder.jpg') }}" alt="{{ badge.name }}" class="badge-circle">
                <span class="badge-label">{{ badge.name }}</span>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No badges earned yet.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Phase 6: Profile Details Section -->
    <section class="profile-section card">
        <div class="section-header">
            <h2>Profile Details</h2>
        </div>
        <div class="details-grid">
            <div class="detail-card editable-card">
                <div class="detail-info">
                    <strong>Full Name</strong>
                    <p>{{ user.name }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="detail-card editable-card">
                <div class="detail-info">
                    <strong>Email Address</strong>
                    <p>{{ user.email }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="detail-card editable-card">
                <div class="detail-info">
                    <strong>Phone Number</strong>
                    <p>{{ user.phone_number or 'Not provided' }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="detail-card editable-card">
                <div class="detail-info">
                    <strong>Role</strong>
                    <p>{{ user.role.capitalize() }}</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Phase 7: Social Links Row -->
    <section class="profile-section card">
        <div class="section-header">
            <h2>On The Web</h2>
            <button id="add-social-link-btn" class="btn btn-secondary">+ Add</button>
        </div>
        <div class="social-links-row">
            {% if social_links %}
                {% for link in social_links %}
                <a href="{{ link.url }}" target="_blank" class="social-link-btn">
                    <i class="fab fa-{{ link.platform | lower }}"></i>
                </a>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <p>No social links added yet.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- 8. Sticky Floating Action Button -->
    <button class="fab">+ Add Certificate</button>

    <!-- Modals -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Profile</h2>
            <form method="POST" action="{{ url_for('main.edit_profile') }}" enctype="multipart/form-data">
                {{ edit_profile_form.hidden_tag() }}
                {{ render_field(edit_profile_form.name) }}
                {{ render_field(edit_profile_form.email) }}
                {{ render_field(edit_profile_form.bio) }}
                {{ render_field(edit_profile_form.profile_pic) }}
                {{ render_field(edit_profile_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-badge-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Badge</h2>
            <form method="POST" action="{{ url_for('main.add_badge') }}">
                {{ add_badge_form.hidden_tag() }}
                {{ render_field(add_badge_form.name) }}
                {{ render_field(add_badge_form.icon_url) }}
                {{ render_field(add_badge_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-social-link-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Social Link</h2>
            <form method="POST" action="{{ url_for('main.add_social_link') }}">
                {{ add_social_link_form.hidden_tag() }}
                {{ render_field(add_social_link_form.platform) }}
                {{ render_field(add_social_link_form.url) }}
                {{ render_field(add_social_link_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-certificate-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Certificate</h2>
            <form method="POST" action="{{ url_for('main.add_certificate') }}">
                {{ add_certificate_form.hidden_tag() }}
                {{ render_field(add_certificate_form.title) }}
                {{ render_field(add_certificate_form.course_id) }}
                {{ render_field(add_certificate_form.submit) }}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/profile_reborn.js') }}"></script>
{% endblock %}
