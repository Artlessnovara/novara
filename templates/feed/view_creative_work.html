{% extends "feed/base.html" %}

{% block title %}{{ work.title }}{% endblock %}

{% block styles %}
<style>
    .work-container { max-width: 900px; margin: auto; }
    .work-view-card { background: var(--card-bg-light); border-radius: var(--border-radius); box-shadow: var(--shadow-md); overflow: hidden; }
    .work-media { width: 100%; max-height: 70vh; background-color: #000; display: flex; justify-content: center; align-items: center; }
    .work-media img, .work-media video { max-width: 100%; max-height: 70vh; }
    .work-info { padding: 2rem; }
    .work-info h1 { margin-top: 0; }
    .work-meta { color: var(--secondary-text-light); margin-bottom: 1.5rem; }

    /* Styles for like/comment section */
    .post-stats { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; color: var(--secondary-text-light); border-top: 1px solid var(--border-color-light); border-bottom: 1px solid var(--border-color-light); margin: 1.5rem 0; }
    .post-actions { display: flex; justify-content: space-around; }
    .post-actions .action-btn { flex: 1; background: none; border: none; color: var(--secondary-text-light); font-weight: 600; cursor: pointer; padding: 0.75rem; border-radius: 5px; transition: background-color 0.2s; }
    .post-actions .action-btn:hover { background-color: var(--hover-overlay-light); }
    .post-actions .action-btn.active { color: var(--primary-color); }
    .comments-section { padding: 1rem 0; }
    .comment { display: flex; gap: 10px; margin-top: 1rem; }
    .comment-content { background: var(--background-color-light); padding: 0.5rem 1rem; border-radius: 15px; flex-grow: 1; }
    .comment-form { display: flex; gap: 10px; margin-top: 1rem; }
    .comment-input { flex-grow: 1; border: 1px solid var(--border-color-light); border-radius: 20px; padding: 8px 15px; }
</style>
{% endblock %}

{% block content %}
<div class="work-container" data-work-id="{{ work.id }}">
    <div class="work-view-card">
        <div class="work-media">
            {% if work.work_type == 'image' %}
                <img src="{{ url_for('static', filename=work.media_url) }}" alt="{{ work.title }}">
            {% elif work.work_type == 'video' %}
                <video src="{{ url_for('static', filename=work.media_url) }}" controls autoplay style="max-width: 100%;"></video>
            {% else %}
                <p>Audio player not implemented yet.</p>
            {% endif %}
        </div>
        <div class="work-info">
            <h1>{{ work.title }}</h1>
            <div class="work-meta">
                Shared by <a href="{{ url_for('feed.profile', user_id=work.artist.id) }}">{{ work.artist.name }}</a> on {{ work.timestamp.strftime('%B %d, %Y') }}
            </div>
            <p>{{ work.description|safe }}</p>

            <div class="post-stats">
                <span class="likes-count">{{ work.likes.count() }} Likes</span>
                <span class="comments-count">{{ work.comments.count() }} Comments</span>
            </div>

            <div class="post-actions">
                <button class="action-btn like-btn {% if current_user.is_authenticated and current_user.id in work.likes|map(attribute='user_id')|list %}active{% endif %}">
                    <i class="fas fa-thumbs-up"></i> Like
                </button>
                <button class="action-btn comment-btn">
                    <i class="fas fa-comment"></i> Comment
                </button>
            </div>

            <div class="comments-section" style="padding-top: 2rem;">
                <h2>Feedback</h2>
                <div class="comment-form">
                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" alt="Your Profile Pic" class="profile-pic-small">
                    <input type="text" class="comment-input" placeholder="Write some feedback...">
                    <button class="btn-primary comment-submit-btn" style="border-radius: 20px;">Post</button>
                </div>
                <div class="comments-list">
                    <!-- Comments will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const workContainer = document.querySelector('.work-container');
    const workId = workContainer.dataset.workId;
    const likeBtn = workContainer.querySelector('.like-btn');
    const likesCountSpan = workContainer.querySelector('.likes-count');
    const commentsList = workContainer.querySelector('.comments-list');
    const commentInput = workContainer.querySelector('.comment-input');
    const commentSubmitBtn = workContainer.querySelector('.comment-submit-btn');

    // --- Like/Unlike Logic ---
    likeBtn.addEventListener('click', () => {
        fetch(`/feed/api/creative_work/${workId}/like`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                likesCountSpan.textContent = `${data.likes_count} Likes`;
                likeBtn.classList.toggle('active', data.liked_by_user);
            }
        });
    });

    // --- Fetch initial comments ---
    fetchAndRenderComments(workId, commentsList);

    // --- Add Comment Logic ---
    commentSubmitBtn.addEventListener('click', () => {
        const content = commentInput.value.trim();
        if (content) {
            fetch(`/feed/api/creative_work/${workId}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    appendComment(data.comment, commentsList);
                    commentInput.value = '';
                }
            });
        }
    });

    function fetchAndRenderComments(workId, commentsListEl) {
        commentsListEl.innerHTML = '<p>Loading comments...</p>';
        fetch(`/feed/api/creative_work/${workId}/comments`)
            .then(response => response.json())
            .then(data => {
                commentsListEl.innerHTML = '';
                if (data.length === 0) {
                    commentsListEl.innerHTML = '<p>No comments yet.</p>';
                } else {
                    data.forEach(comment => appendComment(comment, commentsListEl));
                }
            });
    }

    function appendComment(comment, commentsListEl) {
        const noCommentsMsg = commentsListEl.querySelector('p');
        if (noCommentsMsg) noCommentsMsg.remove();

        const commentEl = document.createElement('div');
        commentEl.classList.add('comment');
        commentEl.innerHTML = `
            <img src="${comment.author.profile_pic}" alt="${comment.author.name}" class="profile-pic-small">
            <div class="comment-content">
                <a href="/feed/profile/${comment.author.id}" style="font-weight: 600; text-decoration: none; color: inherit;">${comment.author.name}</a>
                <p style="margin: 0.25rem 0 0;">${comment.content}</p>
            </div>
        `;
        commentsListEl.appendChild(commentEl);
    }
});
</script>
{% endblock %}
