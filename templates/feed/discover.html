{% extends "layouts/dashboard_layout.html" %}

{% block title %}Discover{% endblock %}

{% block dashboard_content %}
<div class="discover-container">
    <!-- This top bar is specific to the Discover page -->
    <div class="discover-top-bar">
        <div class="discover-top-bar-left">
            <button class="sidebar-toggle icon-btn" id="sidebar-toggle-btn-discover"><i class="fas fa-bars"></i></button>
            <h1 class="discover-title">DISCOVER</h1>
        </div>
        <div class="discover-top-bar-right">
            <a href="{{ url_for('more.resources') }}" class="icon-btn"><i class="fas fa-store"></i></a>
            <a href="{{ url_for('main.profile') }}" class="profile-avatar">
                <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_pic if current_user.is_authenticated and current_user.profile_pic else 'default.jpg')) }}" alt="Profile Avatar">
            </a>
            <button id="create-post-btn" class="btn-primary" style="margin-left: 1rem;">+ Create Post</button>
        </div>
    </div>

    <!-- Stories Row -->
    <div class="stories-row">
        <div class="story-card">
            <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_pic if current_user.is_authenticated and current_user.profile_pic else 'default.jpg')) }}" alt="Add Story">
            <span>Add Story</span>
        </div>
        {% for story in stories %}
        <div class="story-card" data-story-user-id="{{ story.user_id }}">
            <img src="{{ url_for('static', filename='profile_pics/' + story.user.profile_pic) }}" alt="{{ story.user.name }}'s story">
            <span>{{ story.user.name }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Add Story Modal -->
    <div id="add-story-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add to Your Story</h2>
            <form action="{{ url_for('feed.add_story') }}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="story-media">Image or Video:</label>
                    <input type="file" name="media" id="story-media" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="story-caption">Caption:</label>
                    <textarea name="caption" id="story-caption" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 1rem;">Post Story</button>
            </form>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="story-viewer-modal" class="modal">
        <div class="story-viewer-content">
            <span class="close-story-viewer">&times;</span>
            <button class="story-nav prev">&lt;</button>
            <div id="story-content"></div>
            <button class="story-nav next">&gt;</button>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="feed-posts">
        {% for post in posts %}
            <div class="post-card">
                <div class="post-header">
                    <a href="{{ url_for('feed.profile', user_id=post.author.id) }}">
                        <img src="{{ url_for('static', filename='profile_pics/' + post.author.profile_pic) }}" alt="{{ post.author.name }}'s profile picture">
                    </a>
                    <div class="post-author-info">
                        <a href="{{ url_for('feed.profile', user_id=post.author.id) }}" class="author-name">{{ post.author.name }}</a>
                        <div class="timestamp">{{ post.timestamp.strftime('%b %d, %Y') }}</div>
                    </div>
                    <div style="margin-left: auto;">
                        <a href="{{ url_for('main.create_private_chat', other_user_id=post.author.id) }}" class="btn-secondary">Message</a>
                    </div>
                </div>
                <div class="post-text">
                    {{ post.content }}
                </div>
                {% if post.media_url %}
                <div class="post-media">
                    {% if post.media_type == 'images' %}
                        <div class="image-grid">
                            {% for image_url in post.media_url %}
                                <img src="{{ url_for('static', filename=image_url) }}" alt="Post image">
                            {% endfor %}
                        </div>
                    {% elif post.media_type == 'image' %}
                        <img src="{{ url_for('static', filename=post.media_url) }}" alt="Post image">
                    {% elif post.media_type == 'video' %}
                        <div class="video-container">
                            <video>
                                <source src="{{ url_for('static', filename=post.media_url) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="play-button-overlay"><i class="fas fa-play"></i></div>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="post-footer">
                    <div class="post-actions">
                        <div class="post-action" data-action="like" data-post-id="{{ post.id }}"><i class="far fa-heart"></i> Like</div>
                        <div class="post-action" data-action="comment"><i class="far fa-comment"></i> Comment</div>
                        <div class="post-action" data-action="share"><i class="fas fa-share"></i> Share</div>
                    </div>
                    <div class="comment-preview" id="comment-preview-{{ post.id }}">
                        {# Comments will be loaded here via JS #}
                    </div>
                    <div class="comment-box">
                        <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_pic if current_user.is_authenticated and current_user.profile_pic else 'default.jpg')) }}" alt="Your profile picture">
                        <input type="text" class="comment-input" placeholder="Write a comment...">
                    </div>
                </div>
            </div>
        {% else %}
            <p>No posts in your feed yet. Follow some users to see their posts!</p>
        {% endfor %}
    </div>
</div>

<!-- Create Post Modal -->
<div id="create-post-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Create Post</h2>
        <form action="{{ url_for('feed.create_post') }}" method="post" enctype="multipart/form-data">
            <textarea name="content" class="form-control" rows="5" placeholder="What's on your mind, {{ current_user.name }}?"></textarea>
            <div style="margin-top: 1rem;">
                <label for="media">Add to your post:</label>
                <input type="file" name="media" id="media" class="form-control">
            </div>
            <button type="submit" class="btn-primary" style="margin-top: 1rem;">Post</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/discover_feed.js') }}"></script>
    <script>
        // JS for Discover Page
        document.addEventListener('DOMContentLoaded', function() {
            // Modal logic
            const modal = document.getElementById('create-post-modal');
            const btn = document.getElementById('create-post-btn');
            const span = document.getElementsByClassName('close-btn')[0];

            if(btn) {
                btn.onclick = function() {
                    modal.style.display = "block";
                }
            }
            if(span) {
                span.onclick = function() {
                    modal.style.display = "none";
                }
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Sidebar toggle for this specific page
            const discoverSidebarToggle = document.getElementById('sidebar-toggle-btn-discover');
            const mainSidebar = document.getElementById('sidebar');
            if(discoverSidebarToggle && mainSidebar) {
                 discoverSidebarToggle.addEventListener('click', () => {
                    mainSidebar.classList.toggle('open');
                });
            }
        });
    </script>
{% endblock %}
