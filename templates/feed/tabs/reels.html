<div class="upload-reel-card">
    <h3>Upload a Reel</h3>
    <form action="{{ url_for('feed.create_reel') }}" method="POST" enctype="multipart/form-data">
        <div>
            <label for="video">Video File</label>
            <input type="file" name="video" accept="video/*" required>
        </div>
        <div>
            <label for="caption">Caption</label>
            <textarea name="caption" rows="3" placeholder="Write a caption..."></textarea>
        </div>
        <button type="submit">Upload Reel</button>
    </form>
</div>

<div class="reels-viewer-container">
    {% for reel in works %}
    <div class="reel-slide">
        <video src="{{ url_for('static', filename=reel.video_url) }}" loop playsinline class="reel-video"></video>
        <div class="reel-info">
            <div class="reel-author">
                <img src="{{ url_for('static', filename='profile_pics/' + reel.author.profile_pic) }}" alt="{{ reel.author.name }}" class="author-pic">
                <strong>{{ reel.author.name }}</strong>
            </div>
            <p class="reel-caption">{{ reel.caption }}</p>
        </div>
        <div class="reel-actions">
            <button class="action-btn like-btn" data-reel-id="{{ reel.id }}"><i class="fas fa-heart"></i> <span>{{ reel.likes.count() }}</span></button>
            <button class="action-btn comment-btn" data-reel-id="{{ reel.id }}"><i class="fas fa-comment"></i> <span>{{ reel.comments.count() }}</span></button>
            <button class="action-btn share-btn" data-reel-id="{{ reel.id }}"><i class="fas fa-share"></i></button>
        </div>
    </div>
    {% else %}
    <div class="reel-slide" style="display:flex; align-items:center; justify-content:center; text-align:center; color: white;">
        <p>No reels to show right now. <br>Be the first to upload one!</p>
    </div>
    {% endfor %}
</div>

<style>
.upload-reel-card { background: var(--card-bg-light); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); }
.upload-reel-card h3 { margin-top: 0; }
.upload-reel-card form div { margin-bottom: 1rem; }
.upload-reel-card label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
.upload-reel-card input[type="file"], .upload-reel-card textarea { width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid var(--border-color-light); }
.upload-reel-card button { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: 600; cursor: pointer; }

.reels-viewer-container {
    height: 70vh;
    max-height: 800px;
    width: 100%;
    max-width: 450px;
    margin: auto;
    background-color: #000;
    border-radius: var(--border-radius);
    overflow: hidden;
    position: relative;
    scroll-snap-type: y mandatory;
    overflow-y: scroll;
}
/* Hide scrollbar */
.reels-viewer-container::-webkit-scrollbar { display: none; }
.reels-viewer-container { -ms-overflow-style: none; scrollbar-width: none; }

.reel-slide {
    width: 100%;
    height: 100%;
    position: relative;
    scroll-snap-align: start;
    display: flex;
    align-items: center;
    justify-content: center;
}
.reel-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
.reel-info {
    position: absolute;
    bottom: 20px;
    left: 20px;
    color: #fff;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}
.reel-author { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.reel-author .author-pic { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; }
.reel-caption { margin: 0; }

.reel-actions {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.action-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: #fff;
    font-size: 1.5rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.action-btn span { font-size: 0.8rem; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.reels-viewer-container');
    if (!container) return;

    const videos = container.querySelectorAll('.reel-video');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            if (entry.isIntersecting) {
                // Attempt to play the video, but catch errors if it fails (e.g., user hasn't interacted with page)
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Autoplay was prevented:", error);
                        // Optionally, show a play button or some UI element to let the user start playback.
                    });
                }
            } else {
                video.pause();
            }
        });
    }, { threshold: 0.5 });

    videos.forEach(video => {
        observer.observe(video);
        video.addEventListener('click', () => {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        });
    });
});
</script>
