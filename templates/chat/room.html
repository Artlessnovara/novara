{% extends "chat/conversation_layout.html" %}

{% block chat_content %}
<div class="conversation-page">
    {% if current_user.is_authenticated and current_user.chat_wallpaper %}
    <style>
        .message-area {
            {% if current_user.chat_wallpaper.startswith('#') %}
                background-color: {{ current_user.chat_wallpaper }};
            {% else %}
                background-image: url('{{ url_for('static', filename=current_user.chat_wallpaper) }}');
                background-size: cover;
                background-position: center;
            {% endif %}
        }
    </style>
    {% endif %}
    <div class="conversation-header">
        <a href="{{ url_for('main.chat_list') }}" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>
        <div class="conversation-info">
            {% if chat_info.avatar_url %}
            <img src="{{ chat_info.avatar_url }}" alt="{{ chat_info.name }}" class="conversation-avatar">
            {% endif %}
            <div>
                <span class="conversation-name">{{ chat_info.name }}</span>
                <span id="user-status" class="user-status"></span>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('feed.home') }}" class="icon-btn" aria-label="Home"><i class="fa-solid fa-home"></i></a>
            {% if current_user.role in ['admin', 'instructor'] and current_user.can_make_calls %}
                {% if chat_info.room_type == 'private' and chat_info.other_user_id %}
                    {# One-to-one call buttons #}
                    <button id="voice-call-btn" data-callee-id="{{ chat_info.other_user_id }}" class="icon-btn call-btn"><i class="fa-solid fa-phone"></i></button>
                    <button id="video-call-btn" data-callee-id="{{ chat_info.other_user_id }}" class="icon-btn call-btn"><i class="fa-solid fa-video"></i></button>
                {% elif chat_info.room_type != 'private' and chat_info.room_type != 'course' %}
                    {# Group call buttons #}
                    <button id="voice-call-btn" class="icon-btn call-btn"><i class="fa-solid fa-phone"></i></button>
                    <button id="video-call-btn" class="icon-btn call-btn"><i class="fa-solid fa-video"></i></button>
                {% endif %}
            {% endif %}
            <a href="{{ url_for('main.chat_room_info', room_id=chat_info.id) }}" class="info-btn"><i class="fa-solid fa-circle-info"></i></a>
        </div>
    </div>

    <div id="join-call-banner" class="join-call-banner hidden">
        <span>A call is in progress.</span>
        <button id="join-call-btn" class="btn btn-sm btn-success">Join</button>
    </div>

    <div class="message-area">
        {% for message in messages %}
        <div class="message-bubble-wrapper {% if message.user_id == current_user.id %}sender{% else %}receiver{% endif %}" data-message-id="{{ message.id }}" data-is-read="{{ 'true' if message.read_at else 'false' }}">
            <div class="message-bubble">
                {% if message.replied_to_status %}
                    <div class="status-reply-preview">
                        <p class="status-reply-header">Reply to Status</p>
                        <div class="status-reply-content">
                            {% if message.replied_to_status.content_type == 'image' %}
                                <img src="{{ url_for('static', filename=message.replied_to_status.content) }}" class="status-thumbnail">
                            {% else %}
                                {{ message.replied_to_status.content|truncate(50) }}
                            {% endif %}
                        </div>
                    </div>
                {% elif message.is_forwarded %}
                <p class="forwarded-indicator"><i class="fa-solid fa-share"></i> Forwarded</p>
                {% endif %}
                {% if message.file_path %}
                    {% if message.file_name.lower().endswith(('png', 'jpg', 'jpeg', 'gif', 'webp')) %}
                        <img src="/static/{{ message.file_path }}" alt="{{ message.file_name }}" class="message-image">
                    {% elif message.file_name.lower().endswith(('mp4', 'webm', 'ogg')) and 'video' in message.file_name %}
                        <video src="/static/{{ message.file_path }}" controls class="message-video"></video>
                    {% elif message.file_name.lower().endswith(('.mp3', '.wav', '.webm', '.ogg')) %}
                        <audio src="/static/{{ message.file_path }}" controls class="message-audio"></audio>
                    {% else %}
                        <a href="/static/{{ message.file_path }}" class="message-file" download>
                            <i class="fa-solid fa-file-arrow-down"></i> {{ message.file_name }}
                        </a>
                    {% endif %}
                {% else %}
                    {% set content_data = message.content|fromjson(default=none) %}
                    {% if content_data and content_data.type == 'contact' %}
                        <div class="contact-card">
                            <img src="{{ url_for('static', filename='profile_pics/' + content_data.profile_pic) }}" alt="{{ content_data.name }}">
                            <div class="contact-card-info">
                                <strong>{{ content_data.name }}</strong>
                                <a href="{{ url_for('main.view_user', user_id=content_data.user_id) }}">View Profile</a>
                            </div>
                        </div>
                    {% elif content_data and content_data.type == 'location' %}
                        <div class="location-card">
                            <a href="https://www.openstreetmap.org/?mlat={{ content_data.latitude }}&mlon={{ content_data.longitude }}#map=15/{{ content_data.latitude }}/{{ content_data.longitude }}" target="_blank">
                                <i class="fa-solid fa-map-location-dot"></i>
                                <span>View Location</span>
                            </a>
                        </div>
                    {% else %}
                        <p class="message-content">{{ message.content }}</p>
                    {% endif %}
                {% endif %}
                <span class="message-timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                <span class="read-receipts">
                    <i class="fa-solid {% if message.read_at %}fa-check-double{% else %}fa-check{% endif %}"></i>
                </span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="typing-indicator" class="typing-indicator hidden">
        <p></p>
    </div>

    <div id="media-menu" class="media-menu hidden">
        <div class="media-menu-row">
            <button class="media-option-btn" id="media-camera-btn"><i class="fa-solid fa-camera"></i><span>Camera</span></button>
            <button class="media-option-btn" id="media-gallery-btn"><i class="fa-solid fa-images"></i><span>Gallery</span></button>
            <button class="media-option-btn" id="media-document-btn"><i class="fa-solid fa-file-lines"></i><span>Document</span></button>
        </div>
        <div class="media-menu-row">
            <button class="media-option-btn" id="media-voice-btn"><i class="fa-solid fa-microphone"></i><span>Voice Note</span></button>
            <button class="media-option-btn" id="media-contact-btn"><i class="fa-solid fa-user"></i><span>Contact</span></button>
            <button class="media-option-btn" id="media-location-btn"><i class="fa-solid fa-location-dot"></i><span>Location</span></button>
        </div>
        <div class="media-menu-row">
             <button class="media-option-btn" id="create-poll-btn"><i class="fa-solid fa-chart-simple"></i><span>Poll</span></button>
        </div>
    </div>

    <div class="message-input-bar">
        <emoji-picker class="light hidden"></emoji-picker>
        <button class="icon-btn emoji-btn"><i class="fa-regular fa-face-smile"></i></button>
        <button class="icon-btn media-btn"><i class="fa-solid fa-paperclip"></i></button>
        <textarea class="message-input" placeholder="Type a message" rows="1"></textarea>
        <button class="icon-btn send-btn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<!-- Message Forwarding Modal -->
<div id="forward-modal" class="camera-modal hidden">
    <div class="contact-share-content">
        <h3>Forward message to...</h3>
        <div id="forward-chat-list" class="contact-list">
            <!-- Chat list will be populated here by JS -->
        </div>
        <div class="form-actions" style="margin-top: 1rem;">
            <button id="cancel-forward-btn" class="btn btn-secondary">Cancel</button>
            <button id="confirm-forward-btn" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

<!-- Message Context Menu -->
<div id="message-context-menu" class="context-menu hidden">
    <ul>
        <li id="forward-menu-item">Forward</li>
        <!-- Other options like Reply, Copy, Delete can be added here -->
    </ul>
</div>


<!-- Camera Modal -->
<div id="camera-modal" class="camera-modal hidden">
    <div class="camera-modal-content">
        <video id="camera-preview" autoplay playsinline></video>
        <div class="camera-controls">
            <button id="capture-photo-btn" class="camera-control-btn"><i class="fa-solid fa-camera"></i></button>
            <button id="record-video-btn" class="camera-control-btn"><i class="fa-solid fa-video"></i></button>
            <button id="close-camera-btn" class="camera-control-btn close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>
</div>

<!-- Voice Recorder Bar -->
<div id="voice-recorder-bar" class="message-input-bar hidden">
    <i class="fa-solid fa-trash-can icon-btn" id="cancel-voice-btn"></i>
    <div class="voice-recording-info">
        <i class="fa-solid fa-microphone-lines recording-indicator"></i>
        <span id="voice-timer">00:00</span>
    </div>
    <button class="icon-btn send-btn" id="send-voice-btn"><i class="fa-solid fa-paper-plane"></i></button>
</div>

<!-- Call UI Elements -->
<div id="incoming-call-container" class="call-container hidden">
    <div class="incoming-call-box">
        <img id="incoming-caller-avatar" src="" alt="Caller" class="caller-avatar">
        <h3 id="incoming-caller-name"></h3>
        <p id="incoming-call-type"></p>
        <div class="call-actions">
            <button id="decline-call-btn" class="call-action-btn decline"><i class="fa-solid fa-phone-slash"></i></button>
            <button id="accept-call-btn" class="call-action-btn accept"><i class="fa-solid fa-phone"></i></button>
        </div>
    </div>
</div>

<div id="active-call-container" class="call-container hidden">
    <div id="voice-call-avatar-container" class="hidden">
        <img id="active-call-avatar" src="" class="caller-avatar" alt="Active Call Avatar">
    </div>
    <div id="remote-videos-container">
        <!-- Remote videos will be added here dynamically -->
    </div>
    <video id="local-video" class="call-video" autoplay playsinline muted></video>
    <div class="active-call-ui">
        <div class="peer-info">
            <h3 id="active-caller-name"></h3>
            <p id="active-call-timer">00:00</p>
        </div>
        <div class="call-controls">
            <button id="mute-mic-btn" class="call-control-btn"><i class="fa-solid fa-microphone"></i></button>
            <button id="toggle-camera-btn" class="call-control-btn"><i class="fa-solid fa-video"></i></button>
            <button id="end-active-call-btn" class="call-control-btn end-call"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>
</div>

<!-- Contact Share Modal -->
<div id="contact-share-modal" class="camera-modal hidden">
    <div class="contact-share-content">
        <h3>Share a contact</h3>
        <div id="contact-list" class="contact-list">
            <!-- Contacts will be populated here by JS -->
        </div>
        <button id="close-contact-modal-btn" class="btn btn-secondary mt-3">Cancel</button>
    </div>
</div>

<!-- Poll Creation Modal -->
<div id="poll-creation-modal" class="camera-modal hidden">
    <div class="contact-share-content">
        <h3>Create Poll</h3>
        <form id="poll-form">
            <div class="form-group">
                <label for="poll-question">Question</label>
                <input type="text" id="poll-question" class="form-control" required>
            </div>
            <div id="poll-options-container" class="mt-3">
                <label>Options</label>
                <div class="poll-option-input">
                    <input type="text" name="poll_option" class="form-control mb-2" placeholder="Option 1" required>
                </div>
                <div class="poll-option-input">
                    <input type="text" name="poll_option" class="form-control mb-2" placeholder="Option 2" required>
                </div>
            </div>
            <button type="button" id="add-poll-option-btn" class="btn btn-sm btn-outline-secondary mt-2">Add Option</button>
            <div class="form-actions mt-3 d-flex justify-content-end">
                <button type="button" id="cancel-poll-creation-btn" class="btn btn-secondary me-2">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>


<style>
    .voice-recording-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-grow: 1;
        justify-content: center;
    }
    .recording-indicator {
        color: #d9534f;
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .conversation-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: #f0f2f5;
        border-bottom: 1px solid #ddd;
    }
    .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .camera-modal.hidden {
        display: none;
    }
    .camera-modal-content {
        background-color: #333;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #camera-preview {
        width: 100%;
        max-width: 500px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .camera-controls {
        display: flex;
        gap: 20px;
    }
    .camera-control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid white;
        background-color: rgba(0,0,0,0.5);
        color: white;
        font-size: 20px;
        cursor: pointer;
    }
    .camera-control-btn.recording {
        background-color: red;
    }
    .camera-control-btn.close-btn {
        background-color: #555;
    }

    .media-menu {
        position: absolute;
        bottom: 70px; /* Adjust based on input bar height */
        left: 10px;
        right: 10px;
        background-color: #f0f0f0;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        z-index: 1000;
    }
    .media-menu.hidden {
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .media-menu:not(.hidden) {
        transform: translateY(0);
        opacity: 1;
    }
    .media-menu-row {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
    }
    .media-menu-row:last-child {
        margin-bottom: 0;
    }
    .media-option-btn {
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 12px;
        color: #333;
    }
    .media-option-btn i {
        font-size: 24px;
        margin-bottom: 5px;
        width: 50px;
        height: 50px;
        line-height: 50px;
        border-radius: 50%;
        background-color: #fff;
        color: #007bff;
        text-align: center;
    }
    .message-image,
    .message-video {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 5px;
    }
    .message-audio {
        width: 100%;
        max-width: 300px;
    }
    .message-file {
        display: inline-block;
        padding: 10px;
        background-color: rgba(0,0,0,0.1);
        border-radius: 8px;
        text-decoration: none;
        color: inherit;
    }
    .poll-container {
        width: 100%;
    }
    .poll-question {
        font-weight: bold;
        margin-bottom: 10px;
    }
    .poll-option {
        background-color: #f0f2f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
    }
    .poll-option:hover {
        background-color: #e4e6eb;
    }
    .receiver .poll-option {
        background-color: #ffffff;
    }
    .receiver .poll-option:hover {
        background-color: #f7f7f7;
    }
    .poll-option-text {
        flex-grow: 1;
    }
    .poll-option-votes {
        font-size: 0.8em;
        color: #65676b;
        margin-left: 10px;
        z-index: 2; /* Ensure text is above progress bar */
    }
    .poll-option {
        position: relative; /* Needed for progress bar positioning */
        overflow: hidden;
    }
    .poll-option-progress {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background-color: #d2e6ff;
        z-index: 1;
        transition: width 0.3s ease;
        opacity: 0.7;
    }
    .receiver .poll-option-progress {
        background-color: #cceeff;
    }

    /* --- Call UI Styles --- */
    .call-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 3000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .call-container.hidden {
        display: none;
    }
    .incoming-call-box {
        text-align: center;
        color: white;
    }
    .caller-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid white;
        margin-bottom: 20px;
    }
    .call-actions {
        margin-top: 30px;
        display: flex;
        gap: 40px;
    }
    .call-action-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 30px;
        cursor: pointer;
    }
    .call-action-btn.decline { background-color: #d9534f; }
    .call-action-btn.accept { background-color: #5cb85c; }

    /* Active Call */
    #local-video {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 150px;
        border: 2px solid white;
        border-radius: 8px;
        z-index: 3001;
    }
    #remote-videos-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        gap: 5px;
        padding: 5px;
    }
    .remote-video {
        background-color: #000;
        flex-grow: 1;
        object-fit: cover;
        max-width: 50%; /* Example for 2xN grid */
    }
    .active-call-ui {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        z-index: 3002;
        background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
    }
    .peer-info {
        text-align: center;
        margin-bottom: 20px;
    }
    .call-controls {
        display: flex;
        gap: 20px;
    }
    .call-control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 24px;
        cursor: pointer;
    }
    .call-control-btn.active {
        background-color: rgba(255, 255, 255, 0.4);
    }
    .call-control-btn.end-call {
        background-color: #d9534f;
    }
    .join-call-banner {
        padding: 10px 15px;
        background-color: #e6f7ff;
        border-bottom: 1px solid #91d5ff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }
    .join-call-banner.hidden {
        display: none;
    }
    .contact-share-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .contact-list {
        overflow-y: auto;
        flex-grow: 1;
    }
    .contact-item {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .contact-item:hover {
        background-color: #f7f7f7;
    }
    .contact-item img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 15px;
    }
    .contact-card {
        padding: 10px 15px;
        background-color: #f0f2f5;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid #e0e0e0;
    }
    .contact-card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
    }
    .contact-card-info strong {
        display: block;
        font-size: 1.1em;
    }
    .contact-card-info a {
        font-size: 0.9em;
        text-decoration: none;
    }
    .location-card {
        padding: 10px 15px;
    }
    .location-card a {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        font-weight: bold;
    }
    emoji-picker {
        position: absolute;
        bottom: 60px; /* Position above the input bar */
        left: 10px;
        z-index: 1000;
    }
    emoji-picker.hidden {
        display: none;
    }
    .read-receipts {
        font-size: 0.8em;
        color: #888;
        margin-left: 5px;
    }
    .read-receipts .fa-check-double {
        color: #34b7f1; /* Blue for read */
    }
    .user-status {
        font-size: 0.8em;
        color: #666;
    }
    .user-status.online {
        color: #28a745; /* Green for online */
    }
    .context-menu {
        position: absolute;
        z-index: 10000;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 5px 0;
    }
    .context-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .context-menu li {
        padding: 8px 15px;
        cursor: pointer;
    }
    .context-menu li:hover {
        background-color: #f0f0f0;
    }
    #forward-chat-list .contact-item {
        display: flex;
        align-items: center;
    }
    #forward-chat-list input[type="checkbox"] {
        margin-right: 10px;
    }
    .status-reply-preview {
        background-color: rgba(0,0,0,0.05);
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid var(--primary-color);
    }
    .status-reply-header {
        font-weight: 600;
        font-size: 0.9em;
        margin: 0 0 4px 0;
    }
    .status-reply-content {
        font-size: 0.9em;
        opacity: 0.8;
    }
    .status-thumbnail {
        max-width: 50px;
        max-height: 50px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block chat_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chat_info = {{ chat_info|tojson }};
    const current_user_id = {{ current_user.id|tojson }};

    // Join the room
    if (socket && chat_info.id) {
        socket.emit('join', {room_id: chat_info.id});
    }

    register_chat_room_handlers(chat_info, current_user_id);

    // Emoji Picker Logic
    const emojiBtn = document.querySelector('.emoji-btn');
    const emojiPicker = document.querySelector('emoji-picker');
    const messageInput = document.querySelector('.message-input');

    if (emojiBtn && emojiPicker && messageInput) {
        emojiBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            emojiPicker.classList.toggle('hidden');
        });

        emojiPicker.addEventListener('emoji-click', event => {
            messageInput.value += event.detail.unicode;
        });

        document.addEventListener('click', function(event) {
            if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
                emojiPicker.classList.add('hidden');
            }
        });
    }

    // Auto-resize textarea
    const textarea = document.querySelector('.message-input');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    // Scroll to the bottom of the messages
    const messageArea = document.querySelector('.message-area');
    if (messageArea) {
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // Media menu toggle
    const mediaBtn = document.querySelector('.media-btn');
    const mediaMenu = document.getElementById('media-menu');

    if (mediaBtn && mediaMenu) {
        mediaBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            mediaMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', function(event) {
            if (!mediaMenu.contains(event.target) && !mediaBtn.contains(event.target)) {
                mediaMenu.classList.add('hidden');
            }
        });
    }

    // Send Message Logic
    const sendBtn = document.querySelector('.send-btn');
    if (sendBtn && messageInput) {
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
    }

    function sendMessage() {
        const content = messageInput.value.trim();
        if (content) {
            socket.emit('message', {
                room_id: chat_info.id,
                content: content
            });
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
    }
});
</script>
{% endblock %}
