{% extends "feed/base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}Privacy & Security{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card settings-card">
        <div class="card-header">
            <h1>Privacy & Security</h1>
            <p class="text-muted mb-0">Control your privacy, manage account security, and view login history.</p>
        </div>
        <div class="card-body">
            <!-- Security Status -->
            <div class="alert alert-warning" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Add 2FA for better security.</strong>
              <a href="#2fa-section" class="alert-link ms-2">Set up now</a>
            </div>

            <!-- Blocked Users -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <h5>Blocked Users</h5>
                    <small class="text-muted">Manage the accounts you have blocked.</small>
                </div>
                <div class="settings-section-content">
                    <p>You have {{ blocked_users_count }} blocked user(s).</p>
                    <a href="{{ url_for('more.blocked_users') }}" class="btn btn-sm btn-outline-secondary">View and Manage Blocked Users</a>
                </div>
            </div>

            <hr>

            <!-- Two-Factor Authentication -->
            <div class="settings-section" id="2fa-section">
                <div class="settings-section-header">
                    <h5>Two-Factor Authentication (2FA)</h5>
                    <small class="text-muted">Add an extra layer of security to your account.</small>
                </div>
                <div class="settings-section-content">
                    {% if not current_user.two_factor_enabled %}
                        <p>2FA is currently <strong>disabled</strong>.</p>
                        <a href="{{ url_for('more.setup_2fa') }}" class="btn btn-primary">Enable 2FA</a>
                    {% else %}
                        <p>2FA is currently <strong>enabled</strong>.</p>
                        <a href="{{ url_for('more.recovery_codes') }}" class="btn btn-secondary">View Recovery Codes</a>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#disable2faModal">
                            Disable 2FA
                        </button>
                    {% endif %}
                </div>
            </div>

            <hr>

            <!-- Login History / Devices -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <h5>Login History</h5>
                    <small class="text-muted">Here are the most recent logins to your account.</small>
                </div>
                <div class="settings-section-content">
                    {% if login_history %}
                    <ul class="list-group">
                        {% for entry in login_history %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-desktop me-2 text-muted"></i>
                                <strong>{{ entry.user_agent }}</strong>
                                <br>
                                <small class="text-muted">{{ entry.ip_address }} - {{ entry.timestamp.strftime('%B %d, %Y at %I:%M %p') }} UTC</small>
                            </div>
                            {% if loop.first %}
                            <span class="badge bg-light text-dark">Active Now</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No login history found.</p>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-danger mt-3" disabled>Log Out All Other Sessions</button>
                </div>
            </div>

             <hr>

            <!-- Who can see my posts -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <h5>Post Visibility</h5>
                    <small class="text-muted">Set the default privacy for your new posts.</small>
                </div>
                <div class="settings-section-content">
                    <form method="POST" action="{{ url_for('more.privacy_security') }}">
                        <div class="input-group">
                            <select name="default_post_privacy" class="form-select">
                                <option value="public" {% if current_user.default_post_privacy == 'public' %}selected{% endif %}>Public</option>
                                <option value="followers" {% if current_user.default_post_privacy == 'followers' %}selected{% endif %}>Followers</option>
                                <option value="private" {% if current_user.default_post_privacy == 'private' %}selected{% endif %}>Private (Only You)</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Disable 2FA Modal -->
<div class="modal fade" id="disable2faModal" tabindex="-1" aria-labelledby="disable2faModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="disable2faModalLabel">Disable Two-Factor Authentication</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to disable 2FA? This will reduce the security of your account.</p>
        <form method="POST" action="{{ url_for('more.disable_2fa') }}">
            <div class="mb-3">
                <label for="password_confirm_2fa" class="form-label">Please enter your password to confirm:</label>
                <input type="password" name="password" id="password_confirm_2fa" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-danger">Yes, Disable 2FA</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
