{% extends "layouts/dashboard_layout.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}{{ user.name }}'s Profile{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile_reborn.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="profile-container">
    <!-- Optional top banner for profile completion -->
    {% if profile_completion < 100 %}
    <div class="completion-banner">
        <p>Your profile is only {{ profile_completion }}% complete. <a href="#">Complete it now</a> to get the most out of our platform!</p>
    </div>
    {% endif %}

    <!-- 2. Hero / Cover Section -->
    <section class="profile-hero">
        <div class="cover-image" style="background-image: url('{{ user.profile_banner_url or url_for('static', filename='images/course_placeholder.jpg') }}');">
        </div>
        <div class="hero-content">
            <div class="profile-photo-container">
                <img src="{{ url_for('static', filename='profile_pics/' + user.profile_pic) }}" alt="{{ user.name }}'s profile photo" class="profile-photo">
            </div>
            <div class="profile-info">
                <h1>{{ user.name }}</h1>
                <p class="tagline">{{ user.bio | truncate(80) if user.bio else 'Eager to learn and grow.' }}</p>
                <button class="btn btn-gradient edit-profile-btn">Edit Profile</button>
            </div>
        </div>
    </section>

    <!-- 3. Stats Strip -->
    <section class="stats-strip">
        <div class="stat-card">
            <h3>Profile Completion</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ profile_completion }}%;"></div>
            </div>
            <span>{{ profile_completion }}%</span>
        </div>
        <div class="stat-card">
            <h3>Certificates Earned</h3>
            <span class="stat-number">{{ certificates|length }}</span>
        </div>
        <div class="stat-card">
            <h3>Badges Earned</h3>
            <span class="stat-number">{{ badges|length }}</span>
        </div>
    </section>

    <!-- 4. Certificates Section -->
    <section class="profile-section">
        <div class="section-header">
            <h2>My Certificates</h2>
            <button id="add-certificate-btn" class="btn-add">+ Add</button>
        </div>
        <div class="certificates-grid">
            {% for cert in certificates %}
            <div class="certificate-card">
                <div class="cert-icon"><i class="fas fa-award"></i></div>
                <div class="cert-details">
                    <h4>{{ cert.course.title }}</h4>
                    <p>Issued: {{ cert.issued_at.strftime('%b %Y') }}</p>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No certificates earned yet. <a href="{{ url_for('main.courses') }}">Start a course</a> to earn your first one!</p>
            </div>
            {% endfor %}
        </div>
        <a href="#" class="view-all-link">View All</a>
    </section>

    <!-- 5. Achievements / Badges Carousel -->
    <section class="profile-section">
        <div class="section-header">
            <h2>Achievements & Badges</h2>
            <button id="add-badge-btn" class="btn-add">+ Add</button>
        </div>
        <div class="badges-carousel">
            {% for badge in badges %}
            <div class="badge-item">
                <img src="{{ badge.icon_url or url_for('static', filename='images/course_placeholder.jpg') }}" alt="{{ badge.name }}">
                <p>{{ badge.name }}</p>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No badges earned yet.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- 6. Profile Details Section -->
    <section class="profile-section">
        <div class="section-header">
            <h2>Profile Details</h2>
        </div>
        <div class="details-grid">
            <div class="detail-card">
                <div class="detail-info">
                    <strong>Full Name</strong>
                    <p>{{ user.name }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="detail-card">
                <div class="detail-info">
                    <strong>Email Address</strong>
                    <p>{{ user.email }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="detail-card">
                <div class="detail-info">
                    <strong>Phone Number</strong>
                    <p>{{ user.phone_number or 'Not provided' }}</p>
                </div>
                <button class="btn-edit-detail"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <!-- Add more detail cards as needed -->
        </div>
    </section>

    <!-- 7. Social Links Row -->
    <section class="profile-section">
        <div class="section-header">
            <h2>Social Links</h2>
            <button id="add-social-link-btn" class="btn-add">+ Add</button>
        </div>
        <div class="social-links-row">
            {% for link in social_links %}
            <a href="{{ link.url }}" target="_blank" class="social-link-btn">
                <i class="fab fa-{{ link.platform | lower }}"></i>
            </a>
            {% else %}
            <div class="empty-state">
                <p>No social links added yet.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- 8. Sticky Floating Action Button -->
    <button class="fab">+ Add Certificate</button>

    <!-- Modals -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Profile</h2>
            <form method="POST" action="{{ url_for('main.edit_profile') }}" enctype="multipart/form-data">
                {{ edit_profile_form.hidden_tag() }}
                {{ render_field(edit_profile_form.name) }}
                {{ render_field(edit_profile_form.email) }}
                {{ render_field(edit_profile_form.bio) }}
                {{ render_field(edit_profile_form.profile_pic) }}
                {{ render_field(edit_profile_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-badge-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Badge</h2>
            <form method="POST" action="{{ url_for('main.add_badge') }}">
                {{ add_badge_form.hidden_tag() }}
                {{ render_field(add_badge_form.name) }}
                {{ render_field(add_badge_form.icon_url) }}
                {{ render_field(add_badge_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-social-link-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Social Link</h2>
            <form method="POST" action="{{ url_for('main.add_social_link') }}">
                {{ add_social_link_form.hidden_tag() }}
                {{ render_field(add_social_link_form.platform) }}
                {{ render_field(add_social_link_form.url) }}
                {{ render_field(add_social_link_form.submit) }}
            </form>
        </div>
    </div>

    <div id="add-certificate-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add Certificate</h2>
            <form method="POST" action="{{ url_for('main.add_certificate') }}">
                {{ add_certificate_form.hidden_tag() }}
                {{ render_field(add_certificate_form.title) }}
                {{ render_field(add_certificate_form.course_id) }}
                {{ render_field(add_certificate_form.submit) }}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/profile_reborn.js') }}"></script>
{% endblock %}
